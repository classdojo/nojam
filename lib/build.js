// Generated by CoffeeScript 1.6.2
(function() {
  var amdify, async, at, dref, fs, outcome, path, stepc;

  amdify = require("amdify");

  at = amdify.transformers;

  async = require("async");

  stepc = require("stepc");

  outcome = require("outcome");

  fs = require("fs");

  path = require("path");

  dref = require("dref");

  module.exports = (function() {
    /*
    */
    function _Class(ops, packageManagers) {
      var baseDir;

      this.ops = ops;
      this._jam = packageManagers.packageManagers.jam;
      this._directory = process.cwd();
      this._prefix = dref.get(ops.pkg, "jam.packageDir") || "jam";
      baseDir = dref.get(ops.pkg, "jam.baseUrl") || "";
      this._output = this._directory + "/" + this._prefix;
      this._prefix = this._prefix.replace(new RegExp("^" + baseDir), "");
      this._baseDir = this._directory + "/" + baseDir;
    }

    /*
    */


    _Class.prototype.run = function(callback) {
      var dir, o, output, self;

      o = outcome.e(callback);
      dir = this._directory + "/node_modules";
      output = this._output;
      self = this;
      return stepc.async((function() {
        return fs.readdir(dir, this);
      }), o.s(function(dirs) {
        return this(null, self._fixDirs(dir, dirs));
      }), o.s(function(dirs) {
        this.dirs = dirs;
        return self._amdifyAll(dirs, this);
      }), o.s(function() {
        return self._fixPackage(this.dirs, this);
      }), o.s(function() {
        return self._jam.rebuild(this);
      }), callback);
    };

    /*
    */


    _Class.prototype._fixPackage = function(dirs, next) {
      var d, pkgPath,
        _this = this;

      return next();
      d = {};
      dirs.map(function(dir) {
        var bn;

        bn = path.basename(dir);
        return d[bn] = path.join(_this._prefix, bn, require.resolve(dir).replace(dir, "").replace(".js", ""));
      });
      dref.set(this.ops.pkg, "jam.config.paths", d);
      pkgPath = path.join(this.ops.dir, "package.json");
      return fs.writeFile(pkgPath, JSON.stringify(this.ops.pkg, null, 2), next);
    };

    /*
    */


    _Class.prototype._fixDirs = function(base, dirs) {
      return dirs.map(function(d) {
        var pt, stat;

        pt = base + "/" + d;
        while ((stat = fs.lstatSync(pt)).isSymbolicLink()) {
          pt = fs.readlinkSync(pt);
        }
        return pt;
      }).filter(function(d) {
        return path.basename(d).substr(0, 1) !== "." && fs.lstatSync(d).isDirectory();
      });
    };

    /*
    */


    _Class.prototype._amdifyAll = function(dirs, callback) {
      var _this = this;

      return async.map(dirs, (function(dir, callback) {
        return _this._amdify(dir, function(err) {
          return callback();
        });
      }), callback);
    };

    /*
    */


    _Class.prototype._amdify = function(dir, callback) {
      var _this = this;

      return amdify({
        entry: require.resolve(dir),
        prefix: ""
      }, outcome.e(callback).s(function(bundle) {
        var transformer;

        transformer = new at.Template("amd");
        transformer = new at.Copy({
          output: _this._output
        }, transformer);
        return bundle.transform(transformer, callback);
      }));
    };

    return _Class;

  })();

}).call(this);
